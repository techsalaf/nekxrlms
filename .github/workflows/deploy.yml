name: Deploy Laravel to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up PHP
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: composer

      # Step 3: Create required directories
      - name: Create required directories
        run: |
          mkdir -p core/bootstrap/cache
          mkdir -p core/storage/framework/cache
          mkdir -p core/storage/framework/sessions
          mkdir -p core/storage/framework/views
          chmod -R 775 core/bootstrap/cache core/storage

      # Step 4: Cache Composer dependencies
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: core/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('core/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # Step 5: Install Composer dependencies
      - name: Install Composer dependencies
        run: |
          cd core
          composer install --no-dev --optimize-autoloader --no-interaction

      # Step 6: Prepare Laravel for production
      - name: Prepare Laravel for production
        run: |
          cd core
          # Recreate .env with production values to avoid missing file and sqlite fallback
          cat > .env <<'EOF'
APP_NAME="Ad-Dawwaamuun Islamic Foundation"
APP_ENV=production
APP_KEY=${APP_KEY:-base64:hUuZpPc2R4A5Mz4/U3n+hNV/7QZhkLkK9Nhfle9iliQ=}
APP_DEBUG=false
APP_URL=https://elearning.addawwamuun.com/v2

LOG_CHANNEL=stack

DB_CONNECTION=mysql
DB_HOST=${DB_HOST:-localhost}
DB_PORT=${DB_PORT:-3306}
DB_DATABASE=${DB_DATABASE:-u461660264_v2}
DB_USERNAME=${DB_USERNAME:-u461660264_v2}
DB_PASSWORD=${DB_PASSWORD:-changeme}

BROADCAST_DRIVER=log
CACHE_DRIVER=file
QUEUE_CONNECTION=sync
SESSION_DRIVER=file
SESSION_LIFETIME=120

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS=null
MAIL_FROM_NAME=''

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=

PUSHER_APP_ID=
PUSHER_APP_KEY=
PUSHER_APP_SECRET=
PUSHER_APP_CLUSTER=mt1

MIX_PUSHER_APP_KEY="${PUSHER_APP_KEY}"
MIX_PUSHER_APP_CLUSTER="${PUSHER_APP_CLUSTER}"
EOF

          # Override DB credentials from secrets when provided
          if [ -n "${{ secrets.DB_HOST }}" ]; then sed -i "s|DB_HOST=.*|DB_HOST=${{ secrets.DB_HOST }}|" .env; fi
          if [ -n "${{ secrets.DB_PORT }}" ]; then sed -i "s|DB_PORT=.*|DB_PORT=${{ secrets.DB_PORT }}|" .env; fi
          if [ -n "${{ secrets.DB_DATABASE }}" ]; then sed -i "s|DB_DATABASE=.*|DB_DATABASE=${{ secrets.DB_DATABASE }}|" .env; fi
          if [ -n "${{ secrets.DB_USERNAME }}" ]; then sed -i "s|DB_USERNAME=.*|DB_USERNAME=${{ secrets.DB_USERNAME }}|" .env; fi
          if [ -n "${{ secrets.DB_PASSWORD }}" ]; then sed -i "s|DB_PASSWORD=.*|DB_PASSWORD=${{ secrets.DB_PASSWORD }}|" .env; fi

          # Override APP_KEY from secret if provided
          if [ -n "${{ secrets.APP_KEY }}" ]; then sed -i "s|^APP_KEY=.*|APP_KEY=${{ secrets.APP_KEY }}|" .env; fi

          php artisan key:generate --force || true
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear

      # Step 7: Deploy to Hostinger via SFTP
      - name: Deploy to Hostinger via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          local_path: ./
          remote_path: ${{ secrets.FTP_REMOTE_PATH }}
          sftp_only: true
          delete_remote_files: false
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/tests/**
            **/.env
            **/storage/logs/**
            **/vendor/**/tests/**
            **/vendor/**/Tests/**
            **/vendor/**/test/**
            **/vendor/**/.git*
            **/vendor/**/docs/**
            **/vendor/**/examples/**

